<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlockTek Radio - Admin Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #0a0a0a; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; margin-bottom: 40px; }
        .upload-section { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; }
        input { background: rgba(255,255,255,0.1); color: white; }
        input::placeholder { color: rgba(255,255,255,0.5); }
        button { background: linear-gradient(45deg, #8b5cf6, #ec4899); color: white; cursor: pointer; margin-top: 10px; }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .playlist { background: rgba(255,255,255,0.1); padding: 30px; border-radius: 15px; }
        .track { background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; }
        .track-info { flex: 1; }
        .track-actions { display: flex; gap: 10px; }
        .btn-small { width: auto; padding: 8px 16px; font-size: 14px; }
        .btn-danger { background: #dc2626; }
        .btn-success { background: #16a34a; }
        .current-playing { border: 2px solid #8b5cf6; }
        .error-message { background: #dc2626; color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .success-message { background: #16a34a; color: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
        .file-info { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px; }
        .upload-progress { margin-top: 10px; display: none; }
        .progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #8b5cf6, #ec4899); transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽµ BlockTek Radio Admin Panel</h1>
            <p>Upload and manage your music tracks</p>
        </div>

        <div id="messageContainer"></div>

        <div class="upload-section">
            <h2>Upload New Track</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="title">Track Title:</label>
                    <input type="text" id="title" name="title" placeholder="Enter track title" required>
                </div>
                <div class="form-group">
                    <label for="artist">Artist:</label>
                    <input type="text" id="artist" name="artist" placeholder="Enter artist name" required>
                </div>
                <div class="form-group">
                    <label for="audio">Audio File:</label>
                    <input type="file" id="audio" name="audio" accept=".mp3,.wav,.ogg,.m4a,.aac,.flac,.wma,audio/*" required>
                    <div class="file-info">
                        Supported formats: MP3, WAV, OGG, M4A, AAC, FLAC, WMA (Max: 50MB)
                    </div>
                </div>
                <button type="submit" id="uploadBtn">Upload Track</button>
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </form>
        </div>

        <div class="playlist">
            <h2>Current Playlist</h2>
            <div id="playlistContainer">
                <!-- Tracks will be loaded here -->
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentTrack = null;

        // Load playlist on page load
        loadPlaylist();

        // Show message function
        function showMessage(message, type = 'error') {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Upload form handler
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const uploadBtn = document.getElementById('uploadBtn');
            const progressContainer = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            
            // Validate file
            const audioFile = document.getElementById('audio').files[0];
            if (!audioFile) {
                showMessage('Please select an audio file');
                return;
            }

            // Check file size (50MB limit)
            if (audioFile.size > 50 * 1024 * 1024) {
                showMessage('File too large. Maximum size is 50MB.');
                return;
            }

            // Check file type
            const validTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/m4a', 'audio/aac', 'audio/flac', 'audio/x-ms-wma'];
            const validExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.aac', '.flac', '.wma'];
            const fileExtension = audioFile.name.toLowerCase().substring(audioFile.name.lastIndexOf('.'));
            
            if (!validTypes.includes(audioFile.type) && !validExtensions.includes(fileExtension)) {
                showMessage(`Unsupported file type. Please use: ${validExtensions.join(', ')}`);
                return;
            }
            
            const formData = new FormData();
            formData.append('title', document.getElementById('title').value);
            formData.append('artist', document.getElementById('artist').value);
            formData.append('audio', audioFile);
            
            // Show progress
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            progressContainer.style.display = 'block';
            progressFill.style.width = '0%';
            
            try {
                const xhr = new XMLHttpRequest();
                
                // Track upload progress
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = (e.loaded / e.total) * 100;
                        progressFill.style.width = percentComplete + '%';
                    }
                });
                
                xhr.addEventListener('load', () => {
                    try {
                        const result = JSON.parse(xhr.responseText);
                        
                        if (xhr.status === 200 && result.success) {
                            showMessage('Track uploaded successfully!', 'success');
                            document.getElementById('uploadForm').reset();
                            loadPlaylist();
                        } else {
                            showMessage('Upload failed: ' + (result.error || 'Unknown error'));
                        }
                    } catch (e) {
                        showMessage('Upload failed: Invalid response from server');
                    }
                    
                    // Reset UI
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload Track';
                    progressContainer.style.display = 'none';
                });
                
                xhr.addEventListener('error', () => {
                    showMessage('Upload failed: Network error');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload Track';
                    progressContainer.style.display = 'none';
                });
                
                xhr.open('POST', '/api/admin/upload');
                xhr.send(formData);
                
            } catch (error) {
                showMessage('Upload failed: ' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload Track';
                progressContainer.style.display = 'none';
            }
        });

        // Load playlist function
        async function loadPlaylist() {
            try {
                const response = await fetch('/api/admin/playlist');
                const playlist = await response.json();
                renderPlaylist(playlist);
            } catch (error) {
                console.error('Failed to load playlist:', error);
                showMessage('Failed to load playlist');
            }
        }

        // Render playlist
        function renderPlaylist(playlist) {
            const container = document.getElementById('playlistContainer');
            
            if (playlist.length === 0) {
                container.innerHTML = '<p>No tracks uploaded yet.</p>';
                return;
            }
            
            container.innerHTML = playlist.map(track => `
                <div class="track ${currentTrack && currentTrack.id === track.id ? 'current-playing' : ''}" data-id="${track.id}">
                    <div class="track-info">
                        <strong>${track.title}</strong> by ${track.artist}
                        <br>
                        <small>Uploaded: ${new Date(track.uploadedAt).toLocaleString()}</small>
                    </div>
                    <div class="track-actions">
                        <button class="btn-small btn-success" onclick="playTrack(${track.id})">Play</button>
                        <button class="btn-small btn-danger" onclick="deleteTrack(${track.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Play track
        async function playTrack(trackId) {
            try {
                const response = await fetch(`/api/stream/play/${trackId}`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`Now playing: ${result.track.title}`, 'success');
                } else {
                    showMessage('Failed to play track: ' + result.error);
                }
            } catch (error) {
                console.error('Failed to play track:', error);
                showMessage('Failed to play track');
            }
        }

        // Delete track
        async function deleteTrack(trackId) {
            if (!confirm('Are you sure you want to delete this track?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/track/${trackId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Track deleted successfully', 'success');
                    loadPlaylist();
                } else {
                    showMessage('Failed to delete track: ' + result.error);
                }
            } catch (error) {
                console.error('Failed to delete track:', error);
                showMessage('Failed to delete track');
            }
        }

        // Socket event listeners
        socket.on('playlistUpdated', (playlist) => {
            renderPlaylist(playlist);
        });

        socket.on('trackChanged', (track) => {
            currentTrack = track;
            loadPlaylist(); // Refresh to show current playing
        });
    </script>
</body>
</html>
